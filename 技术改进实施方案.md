# 实验室库存管理系统技术改进实施方案

## 1. 数据库结构优化实施

### 1.1 新增模型定义

#### 批次管理模型
```python
# bio-inventory-backend/items/models.py 新增

class Batch(models.Model):
    """批次管理模型 - 支持同一物品的多批次跟踪"""
    
    STATUS_CHOICES = [
        ('ACTIVE', '活跃'),
        ('QUARANTINE', '隔离'),
        ('EXPIRED', '过期'),
        ('CONSUMED', '已用完'),
        ('RECALLED', '召回'),
    ]
    
    QUALITY_STATUS = [
        ('PENDING', '待检'),
        ('PASSED', '合格'),
        ('FAILED', '不合格'),
        ('EXEMPT', '免检'),
    ]
    
    # 关联信息
    item = models.ForeignKey(Item, on_delete=models.CASCADE, related_name='batches')
    batch_number = models.CharField(max_length=100, help_text="批次号")
    supplier_batch_id = models.CharField(max_length=100, blank=True, help_text="供应商批次号")
    
    # 数量管理
    quantity_received = models.DecimalField(max_digits=10, decimal_places=2, help_text="接收数量")
    quantity_remaining = models.DecimalField(max_digits=10, decimal_places=2, help_text="剩余数量")
    quantity_reserved = models.DecimalField(max_digits=10, decimal_places=2, default=0, help_text="预留数量")
    
    # 日期管理
    manufacture_date = models.DateField(null=True, blank=True, help_text="生产日期")
    expiration_date = models.DateField(null=True, blank=True, help_text="过期日期")
    received_date = models.DateField(auto_now_add=True, help_text="接收日期")
    opened_date = models.DateField(null=True, blank=True, help_text="开封日期")
    
    # 状态管理
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='ACTIVE')
    quality_control_status = models.CharField(max_length=20, choices=QUALITY_STATUS, default='PENDING')
    
    # 存储条件
    storage_temperature_actual = models.CharField(max_length=50, blank=True, help_text="实际存储温度")
    storage_conditions_verified = models.BooleanField(default=False, help_text="存储条件已验证")
    
    # 质量控制
    certificate_of_analysis = models.FileField(upload_to='coa/', null=True, blank=True, help_text="分析证书")
    quality_notes = models.TextField(blank=True, help_text="质量备注")
    
    # 元数据
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name='created_batches')
    
    class Meta:
        unique_together = ['item', 'batch_number']
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.item.name} - Batch {self.batch_number}"
    
    @property
    def is_expired(self):
        if not self.expiration_date:
            return False
        return self.expiration_date < timezone.now().date()
    
    @property
    def days_until_expiration(self):
        if not self.expiration_date:
            return None
        return (self.expiration_date - timezone.now().date()).days

class InventoryTransaction(models.Model):
    """库存变动记录 - 完整的库存审计跟踪"""
    
    TRANSACTION_TYPES = [
        ('RECEIVE', '接收入库'),
        ('CONSUME', '消耗出库'),
        ('TRANSFER', '位置转移'),
        ('ADJUSTMENT', '库存调整'),
        ('EXPIRE', '过期处理'),
        ('RETURN', '退货'),
        ('RESERVE', '预留'),
        ('RELEASE', '释放预留'),
    ]
    
    # 基本信息
    transaction_id = models.CharField(max_length=50, unique=True, default=lambda: f"TXN-{uuid.uuid4().hex[:8]}")
    item = models.ForeignKey(Item, on_delete=models.CASCADE, related_name='transactions')
    batch = models.ForeignKey(Batch, on_delete=models.CASCADE, null=True, blank=True, related_name='transactions')
    
    # 变动信息
    transaction_type = models.CharField(max_length=20, choices=TRANSACTION_TYPES)
    quantity_change = models.DecimalField(max_digits=10, decimal_places=2, help_text="数量变化（正数为增加，负数为减少）")
    quantity_before = models.DecimalField(max_digits=10, decimal_places=2, help_text="变动前数量")
    quantity_after = models.DecimalField(max_digits=10, decimal_places=2, help_text="变动后数量")
    
    # 位置信息
    location_from = models.ForeignKey(Location, on_delete=models.SET_NULL, null=True, blank=True, related_name='transactions_from')
    location_to = models.ForeignKey(Location, on_delete=models.SET_NULL, null=True, blank=True, related_name='transactions_to')
    
    # 关联信息
    user = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, help_text="操作用户")
    reference_type = models.CharField(max_length=50, blank=True, help_text="关联类型（如：request, order, manual）")
    reference_id = models.CharField(max_length=100, blank=True, help_text="关联ID")
    
    # 详细信息
    reason = models.TextField(blank=True, help_text="变动原因")
    notes = models.TextField(blank=True, help_text="备注")
    cost_per_unit = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, help_text="单位成本")
    total_cost = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, help_text="总成本")
    
    # 时间戳
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-timestamp']
        indexes = [
            models.Index(fields=['item', '-timestamp']),
            models.Index(fields=['transaction_type', '-timestamp']),
            models.Index(fields=['user', '-timestamp']),
        ]
    
    def __str__(self):
        return f"{self.transaction_id}: {self.item.name} {self.transaction_type}"

class QRCode(models.Model):
    """二维码管理"""
    item = models.OneToOneField(Item, on_delete=models.CASCADE, related_name='qr_code')
    qr_code_data = models.TextField(help_text="二维码数据")
    qr_code_image = models.ImageField(upload_to='qr_codes/', help_text="二维码图片")
    generated_at = models.DateTimeField(auto_now_add=True)
    last_scanned = models.DateTimeField(null=True, blank=True)
    scan_count = models.PositiveIntegerField(default=0)
    
    def __str__(self):
        return f"QR Code for {self.item.name}"
```

#### 权限管理模型
```python
# bio-inventory-backend/users/models.py 扩展

class Department(models.Model):
    """部门管理"""
    name = models.CharField(max_length=100, unique=True)
    code = models.CharField(max_length=20, unique=True)
    description = models.TextField(blank=True)
    head = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name='headed_departments')
    parent = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True, related_name='sub_departments')
    budget_limit = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.name

class LabRole(models.Model):
    """实验室角色"""
    PERMISSION_CHOICES = [
        ('inventory.view', '查看库存'),
        ('inventory.add', '添加库存'),
        ('inventory.change', '修改库存'),
        ('inventory.delete', '删除库存'),
        ('inventory.approve', '批准库存操作'),
        ('requests.view', '查看请求'),
        ('requests.add', '创建请求'),
        ('requests.approve', '批准请求'),
        ('reports.view', '查看报告'),
        ('reports.export', '导出报告'),
        ('admin.users', '用户管理'),
        ('admin.system', '系统管理'),
    ]
    
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    permissions = models.JSONField(default=list, help_text="权限列表")
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.name

class UserProfile(models.Model):
    """用户扩展信息"""
    ACCESS_LEVELS = [
        (1, '基础用户'),
        (2, '高级用户'),
        (3, '管理员'),
        (4, '超级管理员'),
        (5, '系统管理员'),
    ]
    
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='profile')
    employee_id = models.CharField(max_length=50, unique=True, null=True, blank=True)
    department = models.ForeignKey(Department, on_delete=models.SET_NULL, null=True, blank=True)
    lab_role = models.ForeignKey(LabRole, on_delete=models.SET_NULL, null=True, blank=True)
    
    # 联系信息
    phone = models.CharField(max_length=20, blank=True)
    office_location = models.CharField(max_length=100, blank=True)
    emergency_contact = models.CharField(max_length=100, blank=True)
    
    # 权限设置
    access_level = models.IntegerField(choices=ACCESS_LEVELS, default=1)
    can_approve_requests = models.BooleanField(default=False)
    max_request_amount = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # 偏好设置
    notification_preferences = models.JSONField(default=dict, help_text="通知偏好设置")
    dashboard_layout = models.JSONField(default=dict, help_text="仪表板布局设置")
    
    # 状态信息
    is_active = models.BooleanField(default=True)
    last_login_ip = models.GenericIPAddressField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.user.username} Profile"
```

### 1.2 数据迁移脚本

```python
# bio-inventory-backend/items/migrations/0004_add_batch_management.py

from django.db import migrations, models
import django.db.models.deletion
import uuid

class Migration(migrations.Migration):
    dependencies = [
        ('items', '0003_item_fund_id'),
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        # 创建批次表
        migrations.CreateModel(
            name='Batch',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('batch_number', models.CharField(help_text='批次号', max_length=100)),
                ('supplier_batch_id', models.CharField(blank=True, help_text='供应商批次号', max_length=100)),
                ('quantity_received', models.DecimalField(decimal_places=2, help_text='接收数量', max_digits=10)),
                ('quantity_remaining', models.DecimalField(decimal_places=2, help_text='剩余数量', max_digits=10)),
                ('quantity_reserved', models.DecimalField(decimal_places=2, default=0, help_text='预留数量', max_digits=10)),
                ('manufacture_date', models.DateField(blank=True, help_text='生产日期', null=True)),
                ('expiration_date', models.DateField(blank=True, help_text='过期日期', null=True)),
                ('received_date', models.DateField(auto_now_add=True, help_text='接收日期')),
                ('opened_date', models.DateField(blank=True, help_text='开封日期', null=True)),
                ('status', models.CharField(choices=[('ACTIVE', '活跃'), ('QUARANTINE', '隔离'), ('EXPIRED', '过期'), ('CONSUMED', '已用完'), ('RECALLED', '召回')], default='ACTIVE', max_length=20)),
                ('quality_control_status', models.CharField(choices=[('PENDING', '待检'), ('PASSED', '合格'), ('FAILED', '不合格'), ('EXEMPT', '免检')], default='PENDING', max_length=20)),
                ('storage_temperature_actual', models.CharField(blank=True, help_text='实际存储温度', max_length=50)),
                ('storage_conditions_verified', models.BooleanField(default=False, help_text='存储条件已验证')),
                ('certificate_of_analysis', models.FileField(blank=True, help_text='分析证书', null=True, upload_to='coa/')),
                ('quality_notes', models.TextField(blank=True, help_text='质量备注')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_batches', to='auth.user')),
                ('item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='batches', to='items.item')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        
        # 创建库存变动记录表
        migrations.CreateModel(
            name='InventoryTransaction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('transaction_id', models.CharField(default=lambda: f"TXN-{uuid.uuid4().hex[:8]}", max_length=50, unique=True)),
                ('transaction_type', models.CharField(choices=[('RECEIVE', '接收入库'), ('CONSUME', '消耗出库'), ('TRANSFER', '位置转移'), ('ADJUSTMENT', '库存调整'), ('EXPIRE', '过期处理'), ('RETURN', '退货'), ('RESERVE', '预留'), ('RELEASE', '释放预留')], max_length=20)),
                ('quantity_change', models.DecimalField(decimal_places=2, help_text='数量变化（正数为增加，负数为减少）', max_digits=10)),
                ('quantity_before', models.DecimalField(decimal_places=2, help_text='变动前数量', max_digits=10)),
                ('quantity_after', models.DecimalField(decimal_places=2, help_text='变动后数量', max_digits=10)),
                ('reason', models.TextField(blank=True, help_text='变动原因')),
                ('notes', models.TextField(blank=True, help_text='备注')),
                ('cost_per_unit', models.DecimalField(blank=True, decimal_places=2, help_text='单位成本', max_digits=10, null=True)),
                ('total_cost', models.DecimalField(blank=True, decimal_places=2, help_text='总成本', max_digits=10, null=True)),
                ('reference_type', models.CharField(blank=True, help_text='关联类型', max_length=50)),
                ('reference_id', models.CharField(blank=True, help_text='关联ID', max_length=100)),
                ('timestamp', models.DateTimeField(auto_now_add=True)),
                ('batch', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='transactions', to='items.batch')),
                ('item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='transactions', to='items.item')),
                ('location_from', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='transactions_from', to='items.location')),
                ('location_to', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='transactions_to', to='items.location')),
                ('user', models.ForeignKey(help_text='操作用户', null=True, on_delete=django.db.models.deletion.SET_NULL, to='auth.user')),
            ],
            options={
                'ordering': ['-timestamp'],
            },
        ),
        
        # 添加索引
        migrations.AddIndex(
            model_name='inventorytransaction',
            index=models.Index(fields=['item', '-timestamp'], name='items_inventorytransaction_item_timestamp_idx'),
        ),
        migrations.AddIndex(
            model_name='inventorytransaction',
            index=models.Index(fields=['transaction_type', '-timestamp'], name='items_inventorytransaction_type_timestamp_idx'),
        ),
        
        # 添加唯一约束
        migrations.AddConstraint(
            model_name='batch',
            constraint=models.UniqueConstraint(fields=['item', 'batch_number'], name='unique_item_batch'),
        ),
    ]
```

## 2. API接口增强

### 2.1 批次管理API

```python
# bio-inventory-backend/items/serializers.py 新增

class BatchSerializer(serializers.ModelSerializer):
    """批次序列化器"""
    item_name = serializers.CharField(source='item.name', read_only=True)
    days_until_expiration = serializers.ReadOnlyField()
    is_expired = serializers.ReadOnlyField()
    created_by_name = serializers.CharField(source='created_by.username', read_only=True)
    
    class Meta:
        model = Batch
        fields = '__all__'
        read_only_fields = ('created_at', 'updated_at', 'created_by')

class InventoryTransactionSerializer(serializers.ModelSerializer):
    """库存变动记录序列化器"""
    item_name = serializers.CharField(source='item.name', read_only=True)
    batch_number = serializers.CharField(source='batch.batch_number', read_only=True)
    user_name = serializers.CharField(source='user.username', read_only=True)
    location_from_name = serializers.CharField(source='location_from.name', read_only=True)
    location_to_name = serializers.CharField(source='location_to.name', read_only=True)
    
    class Meta:
        model = InventoryTransaction
        fields = '__all__'
        read_only_fields = ('transaction_id', 'timestamp')

# 扩展现有ItemSerializer
class ItemSerializer(serializers.ModelSerializer):
    batches = BatchSerializer(many=True, read_only=True)
    recent_transactions = serializers.SerializerMethodField()
    total_batches = serializers.SerializerMethodField()
    active_batches = serializers.SerializerMethodField()
    
    def get_recent_transactions(self, obj):
        transactions = obj.transactions.all()[:5]
        return InventoryTransactionSerializer(transactions, many=True).data
    
    def get_total_batches(self, obj):
        return obj.batches.count()
    
    def get_active_batches(self, obj):
        return obj.batches.filter(status='ACTIVE').count()
    
    class Meta:
        model = Item
        fields = '__all__'
```

### 2.2 高级API视图

```python
# bio-inventory-backend/items/views.py 增强

from django.db.models import Q, Sum, Count, Avg
from django.utils import timezone
from datetime import timedelta
from rest_framework.decorators import action
from rest_framework.response import Response
from django_filters.rest_framework import DjangoFilterBackend

class ItemViewSet(viewsets.ModelViewSet):
    queryset = Item.objects.all()
    serializer_class = ItemSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter, filters.OrderingFilter]
    filterset_class = ItemFilter
    search_fields = ['name', 'catalog_number', 'vendor__name']
    ordering_fields = ['name', 'created_at', 'expiration_date', 'quantity']
    
    @action(detail=False, methods=['get'])
    def dashboard_stats(self, request):
        """仪表板统计数据"""
        total_items = self.get_queryset().count()
        total_value = self.get_queryset().aggregate(
            total=Sum('price')
        )['total'] or 0
        
        # 过期和即将过期统计
        today = timezone.now().date()
        expired_count = self.get_queryset().filter(
            expiration_date__lt=today
        ).count()
        
        expiring_soon_count = self.get_queryset().filter(
            expiration_date__gte=today,
            expiration_date__lte=today + timedelta(days=30)
        ).count()
        
        # 低库存统计
        low_stock_count = self.get_queryset().filter(
            quantity__lte=models.F('low_stock_threshold')
        ).exclude(low_stock_threshold__isnull=True).count()
        
        return Response({
            'total_items': total_items,
            'total_value': float(total_value),
            'expired_items': expired_count,
            'expiring_soon': expiring_soon_count,
            'low_stock_items': low_stock_count,
            'categories': self.get_queryset().values('item_type__name').annotate(
                count=Count('id')
            ).order_by('-count')[:10]
        })
    
    @action(detail=False, methods=['get'])
    def usage_analytics(self, request):
        """使用分析数据"""
        # 最近30天的使用统计
        thirty_days_ago = timezone.now() - timedelta(days=30)
        
        usage_data = InventoryTransaction.objects.filter(
            timestamp__gte=thirty_days_ago,
            transaction_type='CONSUME'
        ).values('item__name').annotate(
            total_consumed=Sum('quantity_change'),
            transaction_count=Count('id')
        ).order_by('-total_consumed')[:20]
        
        return Response({
            'top_consumed_items': list(usage_data),
            'consumption_trend': self._get_consumption_trend(),
            'cost_analysis': self._get_cost_analysis()
        })
    
    @action(detail=False, methods=['post'])
    def bulk_operations(self, request):
        """批量操作"""
        operation = request.data.get('operation')
        item_ids = request.data.get('item_ids', [])
        
        if not item_ids:
            return Response({'error': '未选择物品'}, status=400)
        
        items = self.get_queryset().filter(id__in=item_ids)
        
        if operation == 'archive':
            items.update(is_archived=True)
            return Response({'message': f'已归档 {items.count()} 个物品'})
        
        elif operation == 'update_location':
            location_id = request.data.get('location_id')
            if location_id:
                items.update(location_id=location_id)
                return Response({'message': f'已更新 {items.count()} 个物品的位置'})
        
        elif operation == 'generate_qr_codes':
            # 批量生成二维码
            for item in items:
                self._generate_qr_code(item)
            return Response({'message': f'已为 {items.count()} 个物品生成二维码'})
        
        return Response({'error': '不支持的操作'}, status=400)
    
    @action(detail=True, methods=['post'])
    def add_batch(self, request, pk=None):
        """为物品添加新批次"""
        item = self.get_object()
        serializer = BatchSerializer(data=request.data)
        
        if serializer.is_valid():
            batch = serializer.save(item=item, created_by=request.user)
            
            # 创建入库记录
            InventoryTransaction.objects.create(
                item=item,
                batch=batch,
                transaction_type='RECEIVE',
                quantity_change=batch.quantity_received,
                quantity_before=0,
                quantity_after=batch.quantity_received,
                user=request.user,
                reason='新批次入库'
            )
            
            return Response(BatchSerializer(batch).data, status=201)
        
        return Response(serializer.errors, status=400)
    
    @action(detail=True, methods=['post'])
    def consume(self, request, pk=None):
        """消耗物品"""
        item = self.get_object()
        quantity = float(request.data.get('quantity', 0))
        batch_id = request.data.get('batch_id')
        reason = request.data.get('reason', '')
        
        if quantity <= 0:
            return Response({'error': '消耗数量必须大于0'}, status=400)
        
        # 选择批次（FIFO原则）
        if batch_id:
            batch = item.batches.get(id=batch_id)
        else:
            batch = item.batches.filter(
                status='ACTIVE',
                quantity_remaining__gt=0
            ).order_by('expiration_date', 'created_at').first()
        
        if not batch or batch.quantity_remaining < quantity:
            return Response({'error': '库存不足'}, status=400)
        
        # 更新批次数量
        old_quantity = batch.quantity_remaining
        batch.quantity_remaining -= quantity
        if batch.quantity_remaining == 0:
            batch.status = 'CONSUMED'
        batch.save()
        
        # 记录变动
        InventoryTransaction.objects.create(
            item=item,
            batch=batch,
            transaction_type='CONSUME',
            quantity_change=-quantity,
            quantity_before=old_quantity,
            quantity_after=batch.quantity_remaining,
            user=request.user,
            reason=reason
        )
        
        return Response({'message': '消耗记录已创建'})

class BatchViewSet(viewsets.ModelViewSet):
    """批次管理视图集"""
    queryset = Batch.objects.all()
    serializer_class = BatchSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    search_fields = ['batch_number', 'item__name']
    
    @action(detail=False, methods=['get'])
    def expiring_soon(self, request):
        """即将过期的批次"""
        days = int(request.query_params.get('days', 30))
        cutoff_date = timezone.now().date() + timedelta(days=days)
        
        batches = self.get_queryset().filter(
            expiration_date__lte=cutoff_date,
            expiration_date__gte=timezone.now().date(),
            status='ACTIVE'
        ).order_by('expiration_date')
        
        serializer = self.get_serializer(batches, many=True)
        return Response(serializer.data)

class InventoryTransactionViewSet(viewsets.ReadOnlyModelViewSet):
    """库存变动记录视图集"""
    queryset = InventoryTransaction.objects.all()
    serializer_class = InventoryTransactionSerializer
    filter_backends = [DjangoFilterBackend, filters.SearchFilter]
    search_fields = ['item__name', 'transaction_type', 'user__username']
    
    @action(detail=False, methods=['get'])
    def summary(self, request):
        """变动汇总"""
        start_date = request.query_params.get('start_date')
        end_date = request.query_params.get('end_date')
        
        queryset = self.get_queryset()
        if start_date:
            queryset = queryset.filter(timestamp__gte=start_date)
        if end_date:
            queryset = queryset.filter(timestamp__lte=end_date)
        
        summary = queryset.values('transaction_type').annotate(
            count=Count('id'),
            total_quantity=Sum('quantity_change')
        ).order_by('transaction_type')
        
        return Response(list(summary))
```

## 3. 前端组件增强

### 3.1 批次管理组件

```typescript
// bio-inventory-frontend/src/components/BatchManagement.tsx

import React, { useState, useEffect } from 'react';
import { Package, Calendar, AlertTriangle, Plus, Edit, Trash2 } from 'lucide-react';

interface Batch {
  id: number;
  batch_number: string;
  quantity_received: number;
  quantity_remaining: number;
  manufacture_date?: string;
  expiration_date?: string;
  status: string;
  quality_control_status: string;
  is_expired: boolean;
  days_until_expiration?: number;
}

interface BatchManagementProps {
  itemId: number;
  token: string;
  onBatchUpdate?: () => void;
}

const BatchManagement: React.FC<BatchManagementProps> = ({ itemId, token, onBatchUpdate }) => {
  const [batches, setBatches] = useState<Batch[]>([]);
  const [loading, setLoading] = useState(true);
  const [showAddForm, setShowAddForm] = useState(false);
  const [newBatch, setNewBatch] = useState({
    batch_number: '',
    quantity_received: '',
    manufacture_date: '',
    expiration_date: '',
    supplier_batch_id: ''
  });

  useEffect(() => {
    fetchBatches();
  }, [itemId]);

  const fetchBatches = async () => {
    try {
      const response = await fetch(`http://127.0.0.1:8000/api/items/${itemId}/`, {
        headers: { 'Authorization': `Token ${token}` }
      });
      const data = await response.json();
      setBatches(data.batches || []);
    } catch (error) {
      console.error('获取批次数据失败:', error);
    } finally {
      setLoading(false);
    }
  };

  const handleAddBatch = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const response = await fetch(`http://127.0.0.1:8000/api/items/${itemId}/add_batch/`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Token ${token}`
        },
        body: JSON.stringify(newBatch)
      });

      if (response.ok) {
        setShowAddForm(false);
        setNewBatch({
          batch_number: '',
          quantity_received: '',
          manufacture_date: '',
          expiration_date: '',
          supplier_batch_id: ''
        });
        fetchBatches();
        onBatchUpdate?.();
      }
    } catch (error) {
      console.error('添加批次失败:', error);
    }
  };

  const getStatusBadge = (batch: Batch) => {
    if (batch.is_expired) {
      return <span className="badge badge-danger">已过期</span>;
    }
    if (batch.days_until_expiration && batch.days_until_expiration <= 30) {
      return <span className="badge badge-warning">即将过期</span>;
    }
    if (batch.status === 'ACTIVE') {
      return <span className="badge badge-success">活跃</span>;
    }
    return <span className="badge badge-secondary">{batch.status}</span>;
  };

  if (loading) {
    return <div className="loading-spinner">加载中...</div>;
  }

  return (
    <div className="batch-management">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-semibold">批次管理</h3>
        <button
          onClick={() => setShowAddForm(true)}
          className="btn btn-primary btn-sm"
        >
          <Plus className="w-4 h-4 mr-2" />
          添加批次
        </button>
      </div>

      {showAddForm && (
        <div className="card mb-4">
          <div className="card-header">
            <h4>添加新批次</h4>
          </div>
          <div className="card-body">
            <form onSubmit={handleAddBatch} className="space-y-4">
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="form-label">批次号 *</label>
                  <input
                    type="text"
                    className="form-input"
                    value={newBatch.batch_number}
                    onChange={(e) => setNewBatch({...newBatch, batch_number: e.target.value})}
                    required
                  />
                </div>
                <div>
                  <label className="form-label">接收数量 *</label>
                  <input
                    type="number"
                    step="0.01"
                    className="form-input"
                    value={newBatch.quantity_received}
                    onChange={(e) => setNewBatch({...newBatch, quantity_received: e.target.value})}
                    required
                  />
                </div>
                <div>
                  <label className="form-label">生产日期</label>
                  <input
                    type="date"
                    className="form-input"
                    value={newBatch.manufacture_date}
                    onChange={(e) => setNewBatch({...newBatch, manufacture_date: e.target.value})}
                  />
                </div>
                <div>
                  <label className="form-label">过期日期</label>
                  <input
                    type="date"
                    className="form-input"
                    value={newBatch.expiration_date}
                    onChange={(e) => setNewBatch({...newBatch, expiration_date: e.target.value})}
                  />
                </div>
              </div>
              <div className="flex space-x-2">
                <button type="submit" className="btn btn-primary">添加批次</button>
                <button
                  type="button"
                  onClick={() => setShowAddForm(false)}
                  className="btn btn-secondary"
                >
                  取消
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      <div className="space-y-3">
        {batches.map((batch) => (
          <div key={batch.id} className="card">
            <div className="card-body">
              <div className="flex justify-between items-start">
                <div className="flex-1">
                  <div className="flex items-center space-x-3 mb-2">
                    <Package className="w-5 h-5 text-gray-500" />
                    <span className="font-medium">批次 {batch.batch_number}</span>
                    {getStatusBadge(batch)}
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                    <div>
                      <span className="text-gray-500">剩余数量:</span>
                      <span className="ml-1 font-medium">{batch.quantity_remaining}</span>
                    </div>
                    <div>
                      <span className="text-gray-500">接收数量:</span>
                      <span className="ml-1">{batch.quantity_received}</span>
                    </div>
                    {batch.expiration_date && (
                      <div className="flex items-center">
                        <Calendar className="w-4 h-4 text-gray-400 mr-1" />
                        <span className="text-gray-500">过期:</span>
                        <span className="ml-1">{new Date(batch.expiration_date).toLocaleDateString()}</span>
                      </div>
                    )}
                    {batch.days_until_expiration !== undefined && (
                      <div className="flex items-center">
                        <AlertTriangle className="w-4 h-4 text-orange-500 mr-1" />
                        <span className="text-orange-600">{batch.days_until_expiration} 天后过期</span>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="flex space-x-2">
                  <button className="p-2 hover:bg-gray-100 rounded">
                    <Edit className="w-4 h-4 text-gray-500" />
                  </button>
                  <button className="p-2 hover:bg-gray-100 rounded">
                    <Trash2 className="w-4 h-4 text-red-500" />
                  </button>
                </div>
              </div>
            </div>
          </div>
        ))}
      </div>

      {batches.length === 0 && (
        <div className="text-center py-8 text-gray-500">
          <Package className="w-12 h-12 mx-auto mb-4 text-gray-300" />
          <p>暂无批次记录</p>
        </div>
      )}
    </div>
  );
};

export default BatchManagement;
```

### 3.2 数据可视化仪表板

```typescript
// bio-inventory-frontend/src/components/Dashboard.tsx

import React, { useState, useEffect } from 'react';
import { BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, LineChart, Line } from 'recharts';
import { Package, AlertTriangle, TrendingUp, DollarSign } from 'lucide-react';

interface DashboardStats {
  total_items: number;
  total_value: number;
  expired_items: number;
  expiring_soon: number;
  low_stock_items: number;
  categories: Array<{name: string; count: number}>;
}

const Dashboard: React.FC<{token: string}> = ({ token }) => {
  const [stats, setStats] = useState<DashboardStats | null>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchDashboardStats();
  }, []);

  const fetchDashboardStats = async () => {
    try {
      const response = await fetch('http://127.0.0.1:8000/api/items/dashboard_stats/', {
        headers: { 'Authorization': `Token ${token}` }
      });
      const data = await response.json();
      setStats(data);
    } catch (error) {
      console.error('获取仪表板数据失败:', error);
    } finally {
      setLoading(false);
    }
  };

  if (loading) {
    return <div className="loading-spinner">加载中...</div>;
  }

  if (!stats) {
    return <div className="text-center text-red-500">加载数据失败</div>;
  }

  const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884D8'];

  return (
    <div className="dashboard space-y-6">
      {/* 统计卡片 */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <div className="card">
          <div className="card-body">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">总物品数</p>
                <p className="text-2xl font-bold text-gray-900">{stats.total_items}</p>
              </div>
              <Package className="w-8 h-8 text-blue-500" />
            </div>
          </div>
        </div>

        <div className="card">
          <div className="card-body">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">总价值</p>
                <p className="text-2xl font-bold text-gray-900">¥{stats.total_value.toLocaleString()}</p>
              </div>
              <DollarSign className="w-8 h-8 text-green-500" />
            </div>
          </div>
        </div>

        <div className="card">
          <div className="card-body">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">过期物品</p>
                <p className="text-2xl font-bold text-red-600">{stats.expired_items}</p>
              </div>
              <AlertTriangle className="w-8 h-8 text-red-500" />
            </div>
          </div>
        </div>

        <div className="card">
          <div className="card-body">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm text-gray-600">低库存</p>
                <p className="text-2xl font-bold text-orange-600">{stats.low_stock_items}</p>
              </div>
              <TrendingUp className="w-8 h-8 text-orange-500" />
            </div>
          </div>
        </div>
      </div>

      {/* 图表区域 */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* 物品类别分布 */}
        <div className="card">
          <div className="card-header">
            <h3 className="card-title">物品类别分布</h3>
          </div>
          <div className="card-body">
            <ResponsiveContainer width="100%" height={300}>
              <PieChart>
                <Pie
                  data={stats.categories}
                  cx="50%"
                  cy="50%"
                  labelLine={false}
                  label={({name, percent}) => `${name} ${(percent * 100).toFixed(0)}%`}
                  outerRadius={80}
                  fill="#8884d8"
                  dataKey="count"
                >
                  {stats.categories.map((entry, index) => (
                    <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                  ))}
                </Pie>
                <Tooltip />
              </PieChart>
            </ResponsiveContainer>
          </div>
        </div>

        {/* 库存状态概览 */}
        <div className="card">
          <div className="card-header">
            <h3 className="card-title">库存状态概览</h3>
          </div>
          <div className="card-body">
            <ResponsiveContainer width="100%" height={300}>
              <BarChart
                data={[
                  { name: '正常', count: stats.total_items - stats.expired_items - stats.expiring_soon - stats.low_stock_items },
                  { name: '即将过期', count: stats.expiring_soon },
                  { name: '已过期', count: stats.expired_items },
                  { name: '低库存', count: stats.low_stock_items }
                ]}
              >
                <CartesianGrid strokeDasharray="3 3" />
                <XAxis dataKey="name" />
                <YAxis />
                <Tooltip />
                <Bar dataKey="count" fill="#8884d8" />
              </BarChart>
            </ResponsiveContainer>
          </div>
        </div>
      </div>

      {/* 快速操作 */}
      <div className="card">
        <div className="card-header">
          <h3 className="card-title">快速操作</h3>
        </div>
        <div className="card-body">
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            <button className="btn btn-primary">
              <Package className="w-
# 实验室库存管理系统技术改进实施方案

## 1. 数据库结构优化实施

### 1.1 新增模型定义

#### 批次管理模型
```python
# bio-inventory-backend/items/models.py 新增

class Batch(models.Model):
    """批次管理模型 - 支持同一物品的多批次跟踪"""
    
    STATUS_CHOICES = [
        ('ACTIVE', '活跃'),
        ('QUARANTINE', '隔离'),
        ('EXPIRED', '过期'),
        ('CONSUMED', '已用完'),
        ('RECALLED', '召回'),
    ]
    
    QUALITY_STATUS = [
        ('PENDING', '待检'),
        ('PASSED', '合格'),
        ('FAILED', '不合格'),
        ('EXEMPT', '免检'),
    ]
    
    # 关联信息
    item = models.ForeignKey(Item, on_delete=models.CASCADE, related_name='batches')
    batch_number = models.CharField(max_length=100, help_text="批次号")
    supplier_batch_id = models.CharField(max_length=100, blank=True, help_text="供应商批次号")
    
    # 数量管理
    quantity_received = models.DecimalField(max_digits=10, decimal_places=2, help_text="接收数量")
    quantity_remaining = models.DecimalField(max_digits=10, decimal_places=2, help_text="剩余数量")
    quantity_reserved = models.DecimalField(max_digits=10, decimal_places=2, default=0, help_text="预留数量")
    
    # 日期管理
    manufacture_date = models.DateField(null=True, blank=True, help_text="生产日期")
    expiration_date = models.DateField(null=True, blank=True, help_text="过期日期")
    received_date = models.DateField(auto_now_add=True, help_text="接收日期")
    opened_date = models.DateField(null=True, blank=True, help_text="开封日期")
    
    # 状态管理
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='ACTIVE')
    quality_control_status = models.CharField(max_length=20, choices=QUALITY_STATUS, default='PENDING')
    
    # 存储条件
    storage_temperature_actual = models.CharField(max_length=50, blank=True, help_text="实际存储温度")
    storage_conditions_verified = models.BooleanField(default=False, help_text="存储条件已验证")
    
    # 质量控制
    certificate_of_analysis = models.FileField(upload_to='coa/', null=True, blank=True, help_text="分析证书")
    quality_notes = models.TextField(blank=True, help_text="质量备注")
    
    # 元数据
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    created_by = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, related_name='created_batches')
    
    class Meta:
        unique_together = ['item', 'batch_number']
        ordering = ['-created_at']
    
    def __str__(self):
        return f"{self.item.name} - Batch {self.batch_number}"
    
    @property
    def is_expired(self):
        if not self.expiration_date:
            return False
        return self.expiration_date < timezone.now().date()
    
    @property
    def days_until_expiration(self):
        if not self.expiration_date:
            return None
        return (self.expiration_date - timezone.now().date()).days

class InventoryTransaction(models.Model):
    """库存变动记录 - 完整的库存审计跟踪"""
    
    TRANSACTION_TYPES = [
        ('RECEIVE', '接收入库'),
        ('CONSUME', '消耗出库'),
        ('TRANSFER', '位置转移'),
        ('ADJUSTMENT', '库存调整'),
        ('EXPIRE', '过期处理'),
        ('RETURN', '退货'),
        ('RESERVE', '预留'),
        ('RELEASE', '释放预留'),
    ]
    
    # 基本信息
    transaction_id = models.CharField(max_length=50, unique=True, default=lambda: f"TXN-{uuid.uuid4().hex[:8]}")
    item = models.ForeignKey(Item, on_delete=models.CASCADE, related_name='transactions')
    batch = models.ForeignKey(Batch, on_delete=models.CASCADE, null=True, blank=True, related_name='transactions')
    
    # 变动信息
    transaction_type = models.CharField(max_length=20, choices=TRANSACTION_TYPES)
    quantity_change = models.DecimalField(max_digits=10, decimal_places=2, help_text="数量变化（正数为增加，负数为减少）")
    quantity_before = models.DecimalField(max_digits=10, decimal_places=2, help_text="变动前数量")
    quantity_after = models.DecimalField(max_digits=10, decimal_places=2, help_text="变动后数量")
    
    # 位置信息
    location_from = models.ForeignKey(Location, on_delete=models.SET_NULL, null=True, blank=True, related_name='transactions_from')
    location_to = models.ForeignKey(Location, on_delete=models.SET_NULL, null=True, blank=True, related_name='transactions_to')
    
    # 关联信息
    user = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, help_text="操作用户")
    reference_type = models.CharField(max_length=50, blank=True, help_text="关联类型（如：request, order, manual）")
    reference_id = models.CharField(max_length=100, blank=True, help_text="关联ID")
    
    # 详细信息
    reason = models.TextField(blank=True, help_text="变动原因")
    notes = models.TextField(blank=True, help_text="备注")
    cost_per_unit = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, help_text="单位成本")
    total_cost = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True, help_text="总成本")
    
    # 时间戳
    timestamp = models.DateTimeField(auto_now_add=True)
    
    class Meta:
        ordering = ['-timestamp']
        indexes = [
            models.Index(fields=['item', '-timestamp']),
            models.Index(fields=['transaction_type', '-timestamp']),
            models.Index(fields=['user', '-timestamp']),
        ]
    
    def __str__(self):
        return f"{self.transaction_id}: {self.item.name} {self.transaction_type}"

class QRCode(models.Model):
    """二维码管理"""
    item = models.OneToOneField(Item, on_delete=models.CASCADE, related_name='qr_code')
    qr_code_data = models.TextField(help_text="二维码数据")
    qr_code_image = models.ImageField(upload_to='qr_codes/', help_text="二维码图片")
    generated_at = models.DateTimeField(auto_now_add=True)
    last_scanned = models.DateTimeField(null=True, blank=True)
    scan_count = models.PositiveIntegerField(default=0)
    
    def __str__(self):
        return f"QR Code for {self.item.name}"
```

#### 权限管理模型
```python
# bio-inventory-backend/users/models.py 扩展

class Department(models.Model):
    """部门管理"""
    name = models.CharField(max_length=100, unique=True)
    code = models.CharField(max_length=20, unique=True)
    description = models.TextField(blank=True)
    head = models.ForeignKey(User, on_delete=models.SET_NULL, null=True, blank=True, related_name='headed_departments')
    parent = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True, related_name='sub_departments')
    budget_limit = models.DecimalField(max_digits=12, decimal_places=2, null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.name

class LabRole(models.Model):
    """实验室角色"""
    PERMISSION_CHOICES = [
        ('inventory.view', '查看库存'),
        ('inventory.add', '添加库存'),
        ('inventory.change', '修改库存'),
        ('inventory.delete', '删除库存'),
        ('inventory.approve', '批准库存操作'),
        ('requests.view', '查看请求'),
        ('requests.add', '创建请求'),
        ('requests.approve', '批准请求'),
        ('reports.view', '查看报告'),
        ('reports.export', '导出报告'),
        ('admin.users', '用户管理'),
        ('admin.system', '系统管理'),
    ]
    
    name = models.CharField(max_length=100, unique=True)
    description = models.TextField(blank=True)
    permissions = models.JSONField(default=list, help_text="权限列表")
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    
    def __str__(self):
        return self.name

class UserProfile(models.Model):
    """用户扩展信息"""
    ACCESS_LEVELS = [
        (1, '基础用户'),
        (2, '高级用户'),
        (3, '管理员'),
        (4, '超级管理员'),
        (5, '系统管理员'),
    ]
    
    user = models.OneToOneField(User, on_delete=models.CASCADE, related_name='profile')
    employee_id = models.CharField(max_length=50, unique=True, null=True, blank=True)
    department = models.ForeignKey(Department, on_delete=models.SET_NULL, null=True, blank=True)
    lab_role = models.ForeignKey(LabRole, on_delete=models.SET_NULL, null=True, blank=True)
    
    # 联系信息
    phone = models.CharField(max_length=20, blank=True)
    office_location = models.CharField(max_length=100, blank=True)
    emergency_contact = models.CharField(max_length=100, blank=True)
    
    # 权限设置
    access_level = models.IntegerField(choices=ACCESS_LEVELS, default=1)
    can_approve_requests = models.BooleanField(default=False)
    max_request_amount = models.DecimalField(max_digits=10, decimal_places=2, null=True, blank=True)
    
    # 偏好设置
    notification_preferences = models.JSONField(default=dict, help_text="通知偏好设置")
    dashboard_layout = models.JSONField(default=dict, help_text="仪表板布局设置")
    
    # 状态信息
    is_active = models.BooleanField(default=True)
    last_login_ip = models.GenericIPAddressField(null=True, blank=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    def __str__(self):
        return f"{self.user.username} Profile"
```

### 1.2 数据迁移脚本

```python
# bio-inventory-backend/items/migrations/0004_add_batch_management.py

from django.db import migrations, models
import django.db.models.deletion
import uuid

class Migration(migrations.Migration):
    dependencies = [
        ('items', '0003_item_fund_id'),
        ('auth', '0012_alter_user_first_name_max_length'),
    ]

    operations = [
        # 创建批次表
        migrations.CreateModel(
            name='Batch',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('batch_number', models.CharField(help_text='批次号', max_length=100)),
                ('supplier_batch_id', models.CharField(blank=True, help_text='供应商批次号', max_length=100)),
                ('quantity_received', models.DecimalField(decimal_places=2, help_text='接收数量', max_digits=10)),
                ('quantity_remaining', models.DecimalField(decimal_places=2, help_text='剩余数量', max_digits=10)),
                ('quantity_reserved', models.DecimalField(decimal_places=2, default=0, help_text='预留数量', max_digits=10)),
                ('manufacture_date', models.DateField(blank=True, help_text='生产日期', null=True)),
                ('expiration_date', models.DateField(blank=True, help_text='过期日期', null=True)),
                ('received_date', models.DateField(auto_now_add=True, help_text='接收日期')),
                ('opened_date', models.DateField(blank=True, help_text='开封日期', null=True)),
                ('status', models.CharField(choices=[('ACTIVE', '活跃'), ('QUARANTINE', '隔离'), ('EXPIRED', '过期'), ('CONSUMED', '已用完'), ('RECALLED', '召回')], default='ACTIVE', max_length=20)),
                ('quality_control_status', models.CharField(choices=[('PENDING', '待检'), ('PASSED', '合格'), ('FAILED', '不合格'), ('EXEMPT', '免检')], default='PENDING', max_length=20)),
                ('storage_temperature_actual', models.CharField(blank=True, help_text='实际存储温度', max_length=50)),
                ('storage_conditions_verified', models.BooleanField(default=False, help_text='存储条件已验证')),
                ('certificate_of_analysis', models.FileField(blank=True, help_text='分析证书', null=True, upload_to='coa/')),
                ('quality_notes', models.TextField(blank=True, help_text='质量备注')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_batches', to='auth.user')),
                ('item', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='batches', to='items.item')),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        
        # 创建库存变动记录表
        migrations.CreateModel(
            name='InventoryTransaction',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('transaction_id', models.CharField(default=lambda: f"TXN-{uuid.uuid4().hex[:8]}", max_length=50, unique=True)),
                ('transaction_type', models.CharField(choices=[('RECEIVE', '接收入库'), ('CONSUME', '消耗出库'), ('TRANSFER',