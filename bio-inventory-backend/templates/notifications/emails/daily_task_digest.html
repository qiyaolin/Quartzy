<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Daily Task Digest</title>
    <style>
        body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; margin: 0; padding: 0; }
        .container { max-width: 600px; margin: 0 auto; padding: 20px; }
        .header { background-color: #007bff; color: white; padding: 20px; text-align: center; border-radius: 5px 5px 0 0; }
        .content { padding: 20px; background-color: #f8f9fa; }
        .section { background-color: white; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #007bff; }
        .section.overdue { border-left-color: #dc3545; }
        .section.upcoming { border-left-color: #ffc107; }
        .section.completed { border-left-color: #28a745; }
        .task-item { padding: 8px 0; border-bottom: 1px solid #eee; }
        .task-item:last-child { border-bottom: none; }
        .task-period { color: #666; font-size: 0.9em; }
        .stats { display: flex; justify-content: space-between; margin: 20px 0; }
        .stat-item { text-align: center; background: white; padding: 15px; border-radius: 5px; flex: 1; margin: 0 5px; }
        .stat-number { font-size: 2em; font-weight: bold; color: #007bff; }
        .footer { text-align: center; padding: 20px; color: #666; font-size: 12px; }
        .button { background-color: #007bff; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }
        .no-content { text-align: center; padding: 40px; color: #666; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Daily Task Digest</h1>
            <p>{{ date|date:"F d, Y" }}</p>
        </div>
        <div class="content">
            <p>Hello {{ user.first_name|default:user.username }},</p>
            
            {% if digest_data.stats.total_active > 0 or digest_data.stats.total_overdue > 0 or digest_data.stats.total_upcoming > 0 %}
                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-number">{{ digest_data.stats.total_active }}</div>
                        <div>Active Tasks</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" style="color: #dc3545;">{{ digest_data.stats.total_overdue }}</div>
                        <div>Overdue</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" style="color: #ffc107;">{{ digest_data.stats.total_upcoming }}</div>
                        <div>Due Soon</div>
                    </div>
                </div>
                
                {% if digest_data.overdue_tasks %}
                <div class="section overdue">
                    <h3 style="color: #dc3545; margin-top: 0;">‚ö†Ô∏è Overdue Tasks</h3>
                    {% for task in digest_data.overdue_tasks %}
                    <div class="task-item">
                        <strong>{{ task.template_name }}</strong>
                        <div class="task-period">Period: {{ task.scheduled_period }} | Due: {{ task.execution_end_date|date:"M d, Y" }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if digest_data.upcoming_tasks %}
                <div class="section upcoming">
                    <h3 style="color: #e67e22; margin-top: 0;">üìÖ Due Soon</h3>
                    {% for task in digest_data.upcoming_tasks %}
                    <div class="task-item">
                        <strong>{{ task.template_name }}</strong>
                        <div class="task-period">Period: {{ task.scheduled_period }} | Due: {{ task.execution_end_date|date:"M d, Y" }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if digest_data.active_tasks %}
                <div class="section">
                    <h3 style="margin-top: 0;">üìã All Active Tasks</h3>
                    {% for task in digest_data.active_tasks %}
                    <div class="task-item">
                        <strong>{{ task.template_name }}</strong>
                        <div class="task-period">
                            Period: {{ task.scheduled_period }} | 
                            Status: {{ task.status|title }} | 
                            Window: {{ task.execution_start_date|date:"M d" }} - {{ task.execution_end_date|date:"M d" }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if digest_data.pending_swaps %}
                <div class="section">
                    <h3 style="margin-top: 0;">üîÑ Pending Swap Requests</h3>
                    {% for swap in digest_data.pending_swaps %}
                    <div class="task-item">
                        <strong>{{ swap.task_instance__template_name }}</strong>
                        <div class="task-period">
                            {{ swap.request_type|title }} request 
                            {% if swap.from_user__username == user.username %}
                                to {{ swap.to_user__username|default:"public pool" }}
                            {% else %}
                                from {{ swap.from_user__username }}
                            {% endif %}
                            | Created: {{ swap.created_at|date:"M d" }}
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                {% if digest_data.completed_tasks %}
                <div class="section completed">
                    <h3 style="color: #28a745; margin-top: 0;">‚úÖ Recently Completed</h3>
                    {% for task in digest_data.completed_tasks %}
                    <div class="task-item">
                        <strong>{{ task.template_name }}</strong>
                        <div class="task-period">Period: {{ task.scheduled_period }} | Completed: {{ task.completed_at|date:"M d, Y" }}</div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                
                <div style="text-align: center; margin: 30px 0;">
                    <a href="{{ action_url }}" class="button">View My Tasks</a>
                </div>
                
            {% else %}
                <div class="no-content">
                    <h3>All caught up! üéâ</h3>
                    <p>You have no active or overdue tasks today.</p>
                </div>
            {% endif %}
            
            <p style="margin-top: 30px; font-size: 0.9em; color: #666;">
                This is your daily task digest. You can update your notification preferences in the system settings.
            </p>
        </div>
        <div class="footer">
            <p>{{ site_name }} - Periodic Task Management</p>
            <p>Hayer Lab - McGill University</p>
        </div>
    </div>
</body>
</html>